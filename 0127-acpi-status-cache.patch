From 8b4ffc793472d1dc9db90cf5708a781a9e225c43 Mon Sep 17 00:00:00 2001
From: Arjan van de Ven <arjan@linux.intel.com>
Date: Sun, 14 May 2017 23:53:08 +0000
Subject: [PATCH 127/127] acpi: status cache

---
 drivers/acpi/scan.c     | 3 ++-
 include/acpi/acpi_bus.h | 2 ++
 2 files changed, 4 insertions(+), 1 deletion(-)

diff --git a/drivers/acpi/scan.c b/drivers/acpi/scan.c
index d53162997f32..006d4b05ed52 100644
--- a/drivers/acpi/scan.c
+++ b/drivers/acpi/scan.c
@@ -1835,7 +1835,8 @@ static void acpi_bus_attach(struct acpi_device *device)
 	if (ACPI_SUCCESS(acpi_bus_get_ejd(device->handle, &ejd)))
 		register_dock_dependent_device(device, ejd);
 
-	acpi_bus_get_status(device);
+	if (!device->status_valid)
+		acpi_bus_get_status(device);
 	/* Skip devices that are not present. */
 	if (!acpi_device_is_present(device)) {
 		acpi_device_clear_enumerated(device);
diff --git a/include/acpi/acpi_bus.h b/include/acpi/acpi_bus.h
index 408c7820e200..2e3a0b701120 100644
--- a/include/acpi/acpi_bus.h
+++ b/include/acpi/acpi_bus.h
@@ -363,6 +363,7 @@ struct acpi_device {
 	struct list_head wakeup_list;
 	struct list_head del_list;
 	struct acpi_device_status status;
+	int status_valid;
 	struct acpi_device_flags flags;
 	struct acpi_device_pnp pnp;
 	struct acpi_device_power power;
@@ -446,6 +447,7 @@ static inline void *acpi_driver_data(struct acpi_device *d)
 static inline void acpi_set_device_status(struct acpi_device *adev, u32 sta)
 {
 	*((u32 *)&adev->status) = sta;
+	adev->status_valid = 1;
 }
 
 static inline void acpi_set_hp_context(struct acpi_device *adev,
-- 
2.13.2

