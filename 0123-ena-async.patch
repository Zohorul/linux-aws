From 350e0c5644af56a72d44ac539cb86b73469cfe35 Mon Sep 17 00:00:00 2001
From: Arjan van de Ven <arjan@linux.intel.com>
Date: Sat, 11 Nov 2017 21:45:31 +0000
Subject: [PATCH 123/129] ena: async

---
 drivers/net/ethernet/amazon/ena/ena_netdev.c | 11 ++++++++++-
 1 file changed, 10 insertions(+), 1 deletion(-)

diff --git a/drivers/net/ethernet/amazon/ena/ena_netdev.c b/drivers/net/ethernet/amazon/ena/ena_netdev.c
index a70bb1bb90e7..e7b636f32f62 100644
--- a/drivers/net/ethernet/amazon/ena/ena_netdev.c
+++ b/drivers/net/ethernet/amazon/ena/ena_netdev.c
@@ -35,6 +35,7 @@
 #ifdef CONFIG_RFS_ACCEL
 #include <linux/cpu_rmap.h>
 #endif /* CONFIG_RFS_ACCEL */
+#include <linux/async.h>
 #include <linux/ethtool.h>
 #include <linux/if_vlan.h>
 #include <linux/kernel.h>
@@ -3582,6 +3583,13 @@ static struct pci_driver ena_pci_driver = {
 	.sriov_configure = pci_sriov_configure_simple,
 };
 
+ASYNC_DOMAIN_EXCLUSIVE(ena_domain);
+
+static void pci_register_driver_async(void *data, async_cookie_t cookie)
+{
+	pci_register_driver(data);
+}
+
 static int __init ena_init(void)
 {
 	pr_info("%s", version);
@@ -3592,7 +3600,8 @@ static int __init ena_init(void)
 		return -ENOMEM;
 	}
 
-	return pci_register_driver(&ena_pci_driver);
+	async_schedule_domain(pci_register_driver_async, &ena_pci_driver, &ena_domain);
+	return 0;
 }
 
 static void __exit ena_cleanup(void)
-- 
2.20.1

